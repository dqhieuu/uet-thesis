\section{The method}
\label{sec:method}

\subsection{Requirements analysis}
\subsubsection{Introduction}
This thesis aims to create a system that can reconstruct a 3D avatar from a single-view portrait image. The system should be able to handle a variety of tasks related to 3D avatar creation, including:
\begin{itemize}
    \item Creating a 3D avatar from a single-view portrait image

    \item Customizing the 3D avatar's facial expression

    \item Trying on different hairstyles on the 3D avatar
\end{itemize}

From the requirements above, an analysis of the system's requirements is conducted to determine the system's architecture and the methods used to create the system. This section clarifies the requirements analysis and the system's architecture, using UML diagrams.

\subsubsection{Use cases}
The use cases of the system are shown in the figure below:
\clearpage

\begin{umlfigure}[Use cases of the system][use_cases]
    @startuml
    left to right direction
    actor User
    rectangle "3D Avatar Reconstruction System" {
    usecase "Create 3D avatar from a portrait image" as UC1
    usecase "Create 3D avatar with customized emotions" as UC2
    usecase "Try on different hairstyles with 3D avatar" as UC3
    }
    User --> UC1
    User --> UC2
    User --> UC3
    @enduml
\end{umlfigure}

\subsubsubsection{Create 3D avatar from a portrait image}
This use case is the main use case of the system. The system should provide a GUI (graphical user interface) to allow the user to upload their images easily. The user uploads a single-view portrait image to the system, and the system will process the image and output a 3D avatar in the form of a 3D mesh reconstructed from the input image. The user can choose to download the 3D avatar as a zip file, which contains the 3D avatar model and texture map. The sequence diagram of this use case is shown in the figure below.

\begin{umlfigure}[Analysis: Sequence diagram: Create 3D avatar from a portrait image.][seq_create_3d_avatar]
    @startuml
    actor User
    participant "3D Avatar Reconstruction System" as System
    User -> System: Uploads image
    System -> System: Processes image
    System -> User: Outputs 3D avatar
    User -> User: Views 3D avatar
    User -> System: Downloads 3D avatar
    @enduml
\end{umlfigure}


\subsubsubsection{Create 3D avatar with customized emotions}

This use case is an extension of the main use case. The user can choose to customize the 3D avatar's emotion by using sliders to adjust the intensity of a set of emotions. The system will then output a 3D avatar with the emotions applied. The user can choose to download the 3D avatar as a zip file, which contains the 3D avatar model and texture map. The sequence diagram of this use case is shown in the figure below.

\begin{umlfigure}[Analysis: Sequence diagram: Create 3D avatar with customized emotions.][seq_create_3d_avatar_emotion]
    @startuml
    actor User
    participant "3D Avatar Reconstruction System" as System
    User -> System: Uploads image
    System -> System: Processes image
    System -> User: Outputs 3D avatar
    User -> System: Adjust emotion
    System -> System: Apply emotion parameters to 3D avatar
    System -> User: Outputs emotion-applied 3D avatar
    User -> User: View 3D avatar
    User -> System: Download 3D avatar
    @enduml

\end{umlfigure}

\subsubsubsection{Try on different hairstyles with 3D avatar}

This use case is an extension of the main use case. The user can choose to try on different hairstyles with the 3D avatar. The system will then output a 3D avatar with the selected hairstyle. The user can choose to download the 3D avatar as a zip file, which contains the 3D avatar model, the texture map, and the hairstyle model. The sequence diagram of this use case is shown in the figure below.

\begin{umlfigure}[Analysis: Sequence diagram: Try on different hairstyles with 3D avatar.][seq_try_on_hairstyle]
    @startuml
    actor User
    participant "3D Avatar Reconstruction System" as System
    User -> System: Uploads image
    System -> System: Processes image
    System -> User: Outputs 3D avatar
    User -> System: Select hairstyle
    System -> System: Apply hairstyle to 3D avatar
    System -> User: Outputs 3D avatar with hairstyle
    User -> User: View 3D avatar
    User -> System: Download 3D avatar
    @enduml
\end{umlfigure}

\subsection{System architecture overview}

\subsubsection{Overall flow}

Essentially, the system architecture serves the purpose of taking a single-view portrait image of a person and outputs a 3D avatar reconstructed from the input image. The overview of the system flow and the decision tree corresponding to the user's options are shown in the figure below.

\includefigure[The system flow overview, with options for reconstruction output.]{images/flow_newest_21.10.png}

The system holds a database for hairstyles, which is convenient for try-on purposes. Instead of going through the standard flow where the system extracts the user's hairstyle from the captured image, the user can try on a variety of hairstyles in the database to see if any of these hairstyles suit their face.

The details of each reconstruction block will be explained in detail in the sections below, where the red blocks are the blocks that are novel and implemented in this thesis.

\subsubsection{Flow: Create 3D avatar from a portrait image}
For taking a single-view portrait image as input, the system provides a front-end interface, i.e. a web page, where the user can upload their image. The front-end interface allows the user to send the image to a gateway server, which is responsible for handling the user's requests and sending the image to the back-end server for processing. By using a gateway server, the system architecture can be modularized, which means multiple reconstruction backends can be used as substitutions. A gateway also allows the system to easily scale up to handle a large number of requests by adding more back-end servers.

The back-end server is responsible for reconstruction tasks and algorithmic tasks.

The implemented flow for creating a 3D avatar from a single-view portrait image is shown in the figure below.

\begin{umlfigure}[Implementation: Sequence diagram: Create 3D avatar from a portrait image.]
    
\end{umlfigure}



To be able to create a 3D avatar from a single-view portrait image, the system needs to be able to reconstruct the 3D head model from the input image. The system uses a pre-trained DECA model \cite{fengLearningAnimatableDetailed2021} to reconstruct the 3D head model. The DECA model takes an image as input and outputs the FLAME \cite{liLearningLightweightMesh2020} model's shape, pose, and expression parameters, along with the extracted face texture. The system then uses the FLAME model's parameters and the extracted face texture to reconstruct the 3D head model. The reconstructed 3D head model is then combined with the reconstructed 3D hair model to create a 3D avatar. The 3D avatar is then sent to the user, where the user can view the 3D avatar using a 3D renderer on the user's web browser.


\subsubsection{Flow: Create 3D avatar with customized emotions}

\subsubsection{Flow: Try on different hairstyles with 3D avatar}


\includefigure[The pipeline of the proposed system.]{images/system_pipeline.png}


\begin{itemize}
    \item The system takes an image input with an API endpoint
    \item The image-to-head encoder outputs the FLAME's shape, pose, and expression parameters, and the extracted face texture.
    \item Optionally, the system can take human-friendly emotion parameters to output FLAME's pose and expression parameters, using a simple emotion-to-FLAME regressive model.
    \item The FLAME-to-output decoder takes FLAME's shape, pose, and expression parameters, texture coordinate, and extracted image texture to output a 3D model with a texture map and a normal map.
    \item While the head is being processed, the image-to-hair model outputs the reconstructed strand-based 3D hair model.
    \item Optionally, a 3D hair model can be chosen from the database instead of using the image-to-hair model for the try-on purpose.
    \item After the head model and the hair model are generated, they are combined with an alignment procedure to create an accurate 3D avatar zip file.
    \item Finally, the zip file is sent to the user, where the 3D renderer on the user's web browser will be used to render the 3D avatar.
\end{itemize}


\subsection{3D face reconstruction}
This

\subsection{Customizable facial emotion}

